<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Slow Burn â€” Habit Tracker</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
  :root{
    --bg:#F3F4F6; --card:#fff; --accent:#5B5BF1; --success:#3BB273; --muted:#6B7280;
    --radius:12px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:#111827}
  .app{max-width:720px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;}
  header{padding:14px 14px;display:flex;align-items:center;gap:12px;background:#000;color:#fff}
  .title{font-weight:700;font-size:18px}
  .dateChip{margin-left:auto;background:#fff;padding:6px 10px;border-radius:999px;font-size:13px;border:1px solid #eee;color:#111}
  main{padding:10px;flex:1}
  .card{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,0.03)}
  .question{font-weight:600;font-size:18px;text-align:center;margin-bottom:10px}
  .option{display:block;padding:12px;border-radius:10px;border:1px solid #EFEFF2;margin:8px 6px;background:#fff;text-align:center}
  .option.selected{background:#F3F4F8;border-color:#E4E6FF}
  .small{font-size:13px;color:var(--muted)}
  .nav{display:flex;gap:8px;margin-top:12px}
  .btn{flex:1;padding:10px;border-radius:10px;background:var(--accent);color:white;text-align:center}
  .btn.ghost{background:#fff;color:#111;border:1px solid #eee}
  nav.bottom{display:flex;gap:8px;padding:10px;background:transparent;position:sticky;bottom:0}
  .tab{flex:1;padding:8px 6px;background:#fff;border-radius:10px;text-align:center;font-size:13px;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
  .activeTab{background:#F0F1FF;color:var(--accent);box-shadow:0 4px 14px rgba(91,91,241,0.08)}
  .panel-row{display:flex;gap:12px;align-items:center}
  .progressbar{height:10px;background:#eee;border-radius:8px;overflow:hidden}
  .progress{height:100%;background:var(--accent)}
  .center{display:flex;align-items:center;justify-content:center}
  footer{padding:12px;text-align:center;font-size:13px;color:var(--muted)}
  input[type="number"], input[type="text"]{padding:8px;border-radius:8px;border:1px solid #eee;width:100%}
  .seg{display:inline-flex;border-radius:10px;overflow:hidden;border:1px solid #eee}
  .seg button{padding:6px 10px;border:0;background:transparent}
  .seg button.active{background:var(--accent);color:white}
  .wide{width:100%}
  canvas{max-width:100%}
  .muted-box{background:#FBFBFD;border-radius:10px;padding:10px;border:1px solid #F0F0F3}
  @media (min-width:600px){ .app{margin:24px auto} }
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="app" id="app">
  <header>
    <div style="display:flex;flex-direction:column">
      <div style="font-size:12px;opacity:0.9">Slow Burn Method</div>
      <div class="title">Habit Tracker</div>
    </div>
    <div class="dateChip" id="dateChip"></div>
  </header>

  <main>
    <!-- Tracker -->
    <div id="viewTracker" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-size:14px;font-weight:600">Effort</div>
          <div class="small" id="progressPill">0/10</div>
        </div>

        <div class="question" id="questionTitle"></div>
        <div id="optionsWrap"></div>

        <div style="display:flex;justify-content:space-between;margin-top:12px">
          <button class="btn ghost" id="backBtn" style="flex:0 0 46%;padding:10px">Back</button>
          <button class="btn" id="nextBtn" style="flex:0 0 46%;padding:10px">Next</button>
        </div>
      </div>
      <div style="font-size:13px;color:var(--muted);text-align:center">Tip: tap an option to save and auto-advance.</div>
    </div>

    <!-- Efforts (history) -->
    <div id="viewEfforts" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><b>Efforts</b></div>
          <div class="small">Range <select id="rangeSelect"><option>14</option><option>30</option><option>7</option></select></div>
        </div>
        <div id="historyList" style="margin-top:12px"></div>
      </div>
      <div class="card">
        <div style="font-weight:600">Effort Chart</div>
        <canvas id="effortChart" height="120"></canvas>
      </div>
    </div>

    <!-- Results -->
    <div id="viewResults" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><b>Results</b></div>
          <div>
            <button id="exportCsv" class="btn ghost">Export CSV</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <canvas id="completionChart" height="120"></canvas>
        </div>

        <div style="margin-top:14px;display:flex;gap:12px">
          <div style="flex:1" class="muted-box">
            <div style="font-weight:600">Today's score</div>
            <div id="todayScore" style="font-size:18px;margin-top:6px"></div>
          </div>
          <div style="flex:1" class="muted-box">
            <div style="font-weight:600">Weight (kg)</div>
            <div id="weightSummary" style="font-size:18px;margin-top:6px">â€”</div>
            <div style="margin-top:8px"><button id="addWeightBtn" class="btn ghost" style="padding:8px;width:100%">Add today's weight</button></div>
          </div>
        </div>

        <div id="weightChartWrap" style="margin-top:12px;display:none" class="card">
          <div style="font-weight:600">Weight trend (last 20 entries)</div>
          <canvas id="weightChart" height="110"></canvas>
        </div>

      </div>
    </div>

    <!-- Onboarding / Settings -->
    <div id="viewSettings" style="display:none">
      <div class="card">
        <div style="font-weight:600">Settings</div>
        <div style="margin-top:8px" class="small">Enter your weight (kg) â€” optional, used for protein guidance</div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <input id="weightInput" type="number" placeholder="e.g. 72" />
          <button id="saveWeightBtn" class="btn" style="flex:0 0 120px;padding:8px">Save</button>
        </div>

        <div style="margin-top:12px"><label><input id="morningRem" type="checkbox" /> Morning reminder (use calendar or manual alert)</label></div>
        <div style="margin-top:6px"><label><input id="eveningRem" type="checkbox" /> Evening reminder</label></div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="saveSettings">Save</button>
          <button class="btn ghost" id="clearAll">Reset Data</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:600;margin-bottom:6px">Export / Backup</div>
        <div class="small" style="margin-bottom:8px">Export your data as CSV and store it safely (Files, email, Drive).</div>
        <div style="display:flex;gap:8px">
          <button id="exportCsv2" class="btn ghost" style="flex:1">Export CSV</button>
          <button id="importBtn" class="btn ghost" style="flex:1">Import CSV</button>
        </div>
        <div style="margin-top:8px" class="small">Tip: export regularly to back up device-only data.</div>
      </div>
    </div>

    <div id="confetti" style="display:none;text-align:center;margin-top:10px">ðŸŽ‰ Saved!</div>
  </main>

  <nav class="bottom">
    <div class="tab" id="tabTracker">Tracker</div>
    <div class="tab" id="tabEfforts">Efforts</div>
    <div class="tab" id="tabResults">Results</div>
    <div class="tab" id="tabSettings">Settings</div>
  </nav>

  <footer>
    Add to Home Screen: Safari â†’ Share â†’ "Add to Home Screen" for app-like behavior.
  </footer>
</div>

<script>
/* improved single-file web app logic. localStorage keys */
const KEY = "sb_entries_v2";
const SETTINGS = "sb_settings_v2";
const WEIGHTS = "sb_weights_v2";

const QUESTIONS = [
  {id:1,title:"How much did you sleep today?",options:["7 hours or more","6 to 7 hours","Under 6 hours"],pos:[0]},
  {id:2,title:"Did you drink at least 2 litres of water today?",options:["Yes!","No"],pos:[0]},
  {id:3,title:"Did you avoid snacking today?",options:["Yes!","No. I had a tiny snack.","No. I snacked a lot."],pos:[0]},
  {id:4,title:"Did you undereat in all meals?",options:["Yes!","No, I overate in one meal","No, I overate in two meals","No, I overate in all three meals"],pos:[0]},
  {id:5,title:"Did you stay away from fatty foods today?",options:["Yes! Nothing fried, oily or creamy.","No"],pos:[0]},
  {id:6,title:"Did you stay away from sweet foods today?",options:["Yes! Nothing sweet.","No. But I kept it to under 100 calories.","No."],pos:[0]},
  {id:7,title:"Did you eat at least 2 cups of vegetables or fruits?",options:["Yes!","No"],pos:[0]},
  {id:8,title:"How much protein did you eat today?",options:["1 to 1.5 grams per kilo of body weight","Under 1 gram per kilo of body weight","More than 1.5 grams per kilo of body weight"],pos:[0,2]},
  {id:9,title:"How much did you walk today?",options:["10,000 steps / 8 km or more","8,000â€“10,000 steps / 6.5â€“8 km","6,000â€“8,000 steps / 5â€“6.5 km","Below 6,000 steps / <5 km"],pos:[0,1]},
  {id:10,title:"Did you exercise today?",options:["Yes! I worked hard.","Yes, but only a light workout","No"],pos:[0,1]}
];

function isoDate(d=new Date()){ const f = new Date(d); f.setHours(0,0,0,0); return f.toISOString().slice(0,10); }
function shortDateLabel(d){ const date = new Date(d); return date.toLocaleDateString(undefined,{day:'2-digit',month:'short'}); }
function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); } catch(e){ return fallback; } }
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

let entries = load(KEY, {});
let settings = load(SETTINGS, {weightKg:null,morning:false,evening:false});
let weights = load(WEIGHTS, []); // [{date:"yyyy-mm-dd", kg: 68.0}, ...]

// DOM refs
const dateChip = document.getElementById("dateChip");
dateChip.innerText = new Date().toLocaleDateString();

const viewTracker = document.getElementById("viewTracker");
const viewEfforts = document.getElementById("viewEfforts");
const viewResults = document.getElementById("viewResults");
const viewSettings = document.getElementById("viewSettings");

const tabTracker = document.getElementById("tabTracker");
const tabEfforts = document.getElementById("tabEfforts");
const tabResults = document.getElementById("tabResults");
const tabSettings = document.getElementById("tabSettings");

const questionTitle = document.getElementById("questionTitle");
const optionsWrap = document.getElementById("optionsWrap");
const progressPill = document.getElementById("progressPill");
const backBtn = document.getElementById("backBtn");
const nextBtn = document.getElementById("nextBtn");

const historyList = document.getElementById("historyList");
const rangeSelect = document.getElementById("rangeSelect");

const completionChartCanvas = document.getElementById("completionChart");
const effortChartCanvas = document.getElementById("effortChart");
const weightChartCanvas = document.getElementById("weightChart");

const todayScore = document.getElementById("todayScore");
const weightSummary = document.getElementById("weightSummary");
const addWeightBtn = document.getElementById("addWeightBtn");
const weightChartWrap = document.getElementById("weightChartWrap");

const weightInput = document.getElementById("weightInput");
const morningRem = document.getElementById("morningRem");
const eveningRem = document.getElementById("eveningRem");
const saveSettingsBtn = document.getElementById("saveSettings");
const clearAllBtn = document.getElementById("clearAll");

const exportCsv = document.getElementById("exportCsv");
const exportCsv2 = document.getElementById("exportCsv2");
const importBtn = document.getElementById("importBtn");
const saveWeightBtn = document.getElementById("saveWeightBtn");
const addWeightButton = document.getElementById("addWeightBtn");
const confettiEl = document.getElementById("confetti");

let currentIdx = 0;
let activeView = 'tracker';
let completionChart=null, effortChart=null, weightChart=null;

function ensureTodayEntry(){
  const k = isoDate();
  if(!entries[k]) entries[k] = {date:k, answers: Array(QUESTIONS.length).fill(null), score:0};
  save(KEY, entries);
}

function computeScore(ans){
  let sum=0;
  for(let i=0;i<QUESTIONS.length;i++){
    const sel = ans[i];
    if(sel===null||sel===undefined) continue;
    if(QUESTIONS[i].pos.includes(sel)) sum++;
  }
  return sum;
}

// Tracker rendering
function renderTracker(){
  ensureTodayEntry();
  const k = isoDate();
  const e = entries[k];
  progressPill.innerText = e.answers.filter(x=>x!==null).length + " / " + QUESTIONS.length;
  questionTitle.innerText = QUESTIONS[currentIdx].title;
  optionsWrap.innerHTML = "";
  QUESTIONS[currentIdx].options.forEach((opt, i)=>{
    const b = document.createElement("button");
    b.className = "option" + (e.answers[currentIdx]===i?" selected":"");
    b.innerText = opt;
    b.onclick = ()=>{
      e.answers[currentIdx] = i;
      e.score = computeScore(e.answers);
      entries[k] = e;
      save(KEY, entries);
      confettiEl.style.display="block";
      setTimeout(()=>confettiEl.style.display="none",700);
      // auto-advance
      if(currentIdx < QUESTIONS.length-1){
        currentIdx++;
        renderTracker();
      } else {
        renderTracker();
      }
      renderResults();
      renderHistory();
      updateEffortChart();
    };
    optionsWrap.appendChild(b);
  });
}

backBtn.onclick = ()=>{ if(currentIdx>0){ currentIdx--; renderTracker(); } };
nextBtn.onclick = ()=>{ if(currentIdx<QUESTIONS.length-1){ currentIdx++; renderTracker(); } };

// History
function renderHistory(){
  historyList.innerHTML = "";
  const days = parseInt(rangeSelect.value || "14");
  for(let i=0;i<days;i++){
    const d = new Date(); d.setDate(d.getDate()-i);
    const k = isoDate(d);
    const e = entries[k] || {date:k,answers:Array(QUESTIONS.length).fill(null),score:0};
    const pct = Math.round((e.answers.filter(x=>x!==null).length/QUESTIONS.length)*100);
    const row = document.createElement("div");
    row.style.display="flex";row.style.alignItems="center";row.style.justifyContent="space-between";row.style.padding="8px 0";
    const left = document.createElement("div");
    left.innerHTML = `<div style="font-weight:600">${d.toLocaleDateString(undefined,{weekday:'short',day:'numeric',month:'short'})}</div><div class="small">Score: ${e.score} â€¢ ${pct}%</div>`;
    const right = document.createElement("div"); right.style.width="150px";
    const pbar = document.createElement("div"); pbar.className="progressbar"; pbar.style.width="140px";
    const p = document.createElement("div"); p.className="progress"; p.style.width = pct + "%";
    pbar.appendChild(p); right.appendChild(pbar);
    row.appendChild(left); row.appendChild(right);
    historyList.appendChild(row);
  }
}

// Results chart
function renderResults(){
  // build data for last N days (14)
  const days = 14;
  const labels = []; const values = []; const effValues = [];
  for(let i=days-1;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    const k = isoDate(d);
    const e = entries[k] || {answers:Array(QUESTIONS.length).fill(null),score:0};
    const pct = Math.round((e.answers.filter(x=>x!==null).length/QUESTIONS.length)*100);
    labels.push(shortDateLabel(k));
    values.push(pct);
    effValues.push(e.score); // raw score (0..10)
  }
  // completionChart (percentage)
  if(completionChart) completionChart.destroy();
  completionChart = new Chart(completionChartCanvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{ label: 'Completion %', data: values, backgroundColor: '#5B5BF1' }]
    },
    options: {
      responsive:true,
      scales: {
        y: { beginAtZero:true, max:100, ticks: { callback: v=>v + '%' } }
      },
      plugins: { legend: { display:false } }
    }
  });

  // Effort chart (show percent also)
  updateEffortChart();

  // today's score and weight
  const today = entries[isoDate()] || {answers:Array(QUESTIONS.length).fill(null),score:0};
  todayScore.innerText = `${today.score} / ${QUESTIONS.length} â€¢ ${Math.round((today.answers.filter(x=>x!==null).length/QUESTIONS.length)*100)}% completed`;

  // weight summary
  if(weights.length>0){
    const last = weights[weights.length-1];
    weightSummary.innerText = `${last.kg.toFixed(1)} kg (${last.date})`;
    renderWeightChart();
  } else {
    weightSummary.innerText = "â€”";
    weightChartWrap.style.display = "none";
    if(weightChart){ weightChart.destroy(); weightChart = null; }
  }
}

function updateEffortChart(){
  // last 20 days effort as percentage of score / 10
  const days = 20;
  const labels=[]; const values=[];
  for(let i=days-1;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    const k = isoDate(d);
    const e = entries[k] || {answers:Array(QUESTIONS.length).fill(null),score:0};
    const pct = Math.round((e.score / QUESTIONS.length) * 100);
    labels.push(shortDateLabel(k));
    values.push(pct);
  }
  if(effortChart) effortChart.destroy();
  effortChart = new Chart(effortChartCanvas.getContext('2d'), {
    type:'line',
    data: { labels, datasets: [{ label:'Effort %', data: values, borderColor:'#5B5BF1', backgroundColor:'rgba(91,91,241,0.08)', fill:true }] },
    options: {
      responsive:true,
      scales: { y: { beginAtZero:true, max:100, ticks:{callback:v=>v+'%'} } },
      plugins:{ legend:{ display:false } }
    }
  });
}

// Weight chart
function renderWeightChart(){
  if(weights.length===0) return;
  const last = weights.slice(-20);
  const labels = last.map(w => shortDateLabel(w.date));
  const data = last.map(w => w.kg);
  weightChartWrap.style.display = "block";
  if(weightChart) weightChart.destroy();
  weightChart = new Chart(weightChartCanvas.getContext('2d'), {
    type:'line',
    data:{ labels, datasets:[{ label:'Weight (kg)', data, borderColor:'#3BB273', backgroundColor:'rgba(59,178,115,0.08)', fill:true }] },
    options:{ responsive:true, scales:{ y:{ beginAtZero:false } }, plugins:{ legend:{ display:false } } }
  });
}

// navigation
function showView(v){
  activeView = v;
  viewTracker.style.display = (v==='tracker')?'block':'none';
  viewEfforts.style.display = (v==='efforts')?'block':'none';
  viewResults.style.display = (v==='results')?'block':'none';
  viewSettings.style.display = (v==='settings')?'block':'none';
  [tabTracker,tabEfforts,tabResults,tabSettings].forEach(t=>t.classList.remove('activeTab'));
  if(v==='tracker') tabTracker.classList.add('activeTab');
  if(v==='efforts') tabEfforts.classList.add('activeTab');
  if(v==='results') tabResults.classList.add('activeTab');
  if(v==='settings') tabSettings.classList.add('activeTab');
  if(v==='tracker') renderTracker();
  if(v==='results') renderResults();
  if(v==='efforts') { renderHistory(); updateEffortChart(); }
  if(v==='settings') loadSettingsUI();
}

tabTracker.onclick = ()=>showView('tracker');
tabEfforts.onclick = ()=>showView('efforts');
tabResults.onclick = ()=>showView('results');
tabSettings.onclick = ()=>showView('settings');

rangeSelect.onchange = ()=>{ renderHistory(); updateEffortChart(); };

// settings
function loadSettingsUI(){
  weightInput.value = settings.weightKg || '';
  morningRem.checked = !!settings.morning;
  eveningRem.checked = !!settings.evening;
}
saveSettingsBtn.onclick = ()=>{
  settings.weightKg = weightInput.value ? Number(weightInput.value) : null;
  settings.morning = morningRem.checked;
  settings.evening = eveningRem.checked;
  save(SETTINGS, settings);
  alert("Settings saved");
  renderResults();
};
clearAllBtn.onclick = ()=>{
  if(confirm("This will delete all saved data on this device. Continue?")){
    entries = {}; save(KEY, entries); weights = []; save(WEIGHTS, weights); location.reload();
  }
};

// add weight
saveWeightBtn.onclick = ()=>{ // from settings input
  const val = parseFloat(weightInput.value);
  if(!val) { alert("Enter weight"); return; }
  addWeight(isoDate(), val);
  settings.weightKg = val; save(SETTINGS, settings); renderResults();
  alert("Weight saved");
};
addWeightButton.onclick = ()=>{ // quick add today's weight: prompt
  const r = prompt("Enter today's weight in kg (e.g. 68.0)");
  if(r){ const v = parseFloat(r); if(!isNaN(v)){ addWeight(isoDate(), v); renderResults(); save(WEIGHTS, weights); alert("Saved"); } }
};

function addWeight(date, kg){
  // replace entry for date if exists
  const idx = weights.findIndex(w => w.date === date);
  if(idx >= 0){ weights[idx].kg = kg; } else { weights.push({date, kg}); }
  // keep sorted by date
  weights.sort((a,b)=> new Date(a.date) - new Date(b.date));
  save(WEIGHTS, weights);
}

// CSV export
function exportCSVfile(){
  const rows = [["date","score","completionPct","answers"]];
  const today = new Date();
  for(let i=0;i<365;i++){
    const d = new Date(); d.setDate(today.getDate()-i);
    const k = isoDate(d);
    const e = entries[k] || {answers:Array(QUESTIONS.length).fill(null),score:0};
    const pct = Math.round((e.answers.filter(x=>x!==null).length/QUESTIONS.length)*100);
    rows.push([k, e.score, pct, e.answers.map(a=>a===null?"":a).join("|")]);
  }
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download = "habit_export.csv"; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
}

exportCsv.onclick = exportCSVfile;
exportCsv2.onclick = exportCSVfile;
importBtn.onclick = ()=>{ alert("Import from CSV not implemented in this quick build. I can add that next if you want."); };

// startup
(function init(){
  entries = load(KEY, {});
  settings = load(SETTINGS, settings);
  weights = load(WEIGHTS, weights);
  ensureTodayEntry();
  showView('tracker');
  renderResults();
  renderHistory();
  loadSettingsUI();
})();
</script>
</body>
</html>
